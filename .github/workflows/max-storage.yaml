name: Build Kiwi Next
on: push
# on: [workflow_call]


jobs:
  build:
    name: Build Kiwi Next
    timeout-minutes: 1200
    runs-on: self-hosted
    
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        platform: [arm]
        # platform: [arm, arm64, x86, x64]
    
    steps:
      - name: CI workflow device configuration
        run: |
          df -h
          uname -a
          lscpu
          free -h

      - name: Enabling i386 and updating APT repository
        run:  |
          sudo dpkg --add-architecture i386
          sudo apt-get update
          sudo apt-get upgrade -y

      - name: Free space check
        run: |
          echo "Free space:"
          df -h

      - name: Installing Python and OpenJDK
        run: sudo apt install -y git lsb-release python2 openjdk-8-jdk-headless libncurses5 ccache file wget
        
      - name: Create necessary folders
        run: |
          sudo mkdir -p /usr/local/share/fonts
          rm -rfv $GITHUB_WORKSPACE/*
        
      - name: Install chromium depot tools
        run: git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git $GITHUB_WORKSPACE/depot_tools --depth 1
        
      - name: Download chromium source code
        run: |
          export PATH="$PATH:$GITHUB_WORKSPACE/depot_tools"  # TODO: fix
          mkdir $GITHUB_WORKSPACE/chromium && cd $GITHUB_WORKSPACE/chromium

          fetch --nohooks --nohistory android
          
      - name: Install chromium build depends
        run: |
          export PATH="$PATH:$GITHUB_WORKSPACE/depot_tools"  # TODO: fix
          cd $GITHUB_WORKSPACE/chromium/src
          
          echo "target_os = [ 'android' ]" >> ../.gclient
          gclient sync -D --no-history -v 
          
          wget https://gist.githubusercontent.com/ZhymabekRoman/fdc6191e3a70c11bdcbca97bfddf4c83/raw/697fc96e675f56e5a9de563f1d94b00565f917f9/no_snapcraft.diff
          patch build/install-build-deps.sh no_snapcraft.diff
          build/install-build-deps.sh --android
          gclient runhooks
     
      - name: Free space check
        run: |
          echo "Free space:"
          df -h
     
      - name: Settings build config
        run: |
          export PATH="$PATH:$GITHUB_WORKSPACE/depot_tools"  # TODO: fix
          cd $GITHUB_WORKSPACE/chromium/src
          
          mkdir -p out/Default
          
          cat <<EOF > out/Default/args.gn
          target_os = "android"
          target_cpu = "arm"
          is_component_build = false
          is_debug = false
          is_official_build = true
          symbol_level = 1
          disable_fieldtrial_testing_config = true
          dfmify_dev_ui = false
          disable_autofill_assistant_dfm = true
          disable_tab_ui_dfm = true
          ffmpeg_branding = "Chrome"
          proprietary_codecs = true
          is_cfi = true
          use_cfi_cast = true
          enable_gvr_services = false
          enable_remoting = false
          enable_reporting = false
          EOF

          gn gen out/Default

      - name: Build APK
        working-directory: ${{ github.workspace }}/chromium/src
        run: |
          export PATH="$PATH:$GITHUB_WORKSPACE/depot_tools"  # TODO: fix
          cd $GITHUB_WORKSPACE/chromium/src
          
          autoninja -C out/Default chrome_public_apk -j 20
 
      - name: Check out files
        run: |
          cd $GITHUB_WORKSPACE/chromium/src
          ls out/
          ls out/Default
          ls out/Default/bin/chrome_public_apk
      
      - name: Free space check
        run: |
          echo "Free space:"
          df -h
      
      - name: Upload artefacts
        uses: actions/upload-artifact@v2
        with:
          name: artifact
          path: ${{ github.workspace }}/chromium/src/out/Default
